"use strict";var WebSocketClient=(()=>{var m=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var E=(a,s)=>{for(var e in s)m(a,e,{get:s[e],enumerable:!0})},C=(a,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of _(s))!T.call(a,n)&&n!==e&&m(a,n,{get:()=>s[n],enumerable:!(t=b(s,n))||t.enumerable});return a};var v=a=>C(m({},"__esModule",{value:!0}),a);var N={};E(N,{CONNECTION_STATES:()=>o,EventEmitter:()=>u,MESSAGE_TYPES:()=>r,WebSocketClient:()=>c,default:()=>S});var o={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected",RECONNECTING:"reconnecting",AUTHENTICATING:"authenticating",AUTHENTICATED:"authenticated",CLOSING:"closing",CLOSED:"closed"},r={AUTH:"auth",AUTH_SUCCESS:"auth_success",AUTH_ERROR:"auth_error",AUTH_REQUIRED:"auth_required",CHAT_MESSAGE:"chat_message",ADMIN_COMMAND:"admin_command",GET_USERS:"get_users",USERS_LIST:"users_list",USER_JOINED:"user_joined",USER_LEFT:"user_left",PING:"ping",PONG:"pong",ADMIN_ANNOUNCEMENT:"admin_announcement",WELCOME:"welcome",ERROR:"error"},f={autoReconnect:!0,maxReconnectAttempts:5,reconnectDelay:1e3,maxReconnectDelay:3e4,reconnectDecay:1.5,token:null,tokenRefreshCallback:null,heartbeatInterval:3e4,heartbeatTimeout:5e3,queueMessages:!0,maxQueueSize:100,debug:!1,logLevel:"info"},u=class{constructor(){this._events={}}on(s,e){return this._events[s]||(this._events[s]=[]),this._events[s].push(e),this}once(s,e){let t=(...n)=>{this.off(s,t),e(...n)};return this.on(s,t)}off(s,e){if(!this._events[s])return this;if(!e)return delete this._events[s],this;let t=this._events[s],n=t.indexOf(e);return n!==-1&&t.splice(n,1),this}emit(s,...e){return this._events[s]?(this._events[s].slice().forEach(n=>{try{n(...e)}catch(i){console.error(`Error in event listener for '${String(s)}':`,i)}}),!0):!1}listenerCount(s){return this._events[s]?this._events[s].length:0}},c=class extends u{constructor(e,t={}){super();this.state=o.DISCONNECTED;this.ws=null;this.lastError=null;this.authenticated=!1;this.userInfo=null;this.reconnectAttempts=0;this.reconnectTimer=null;this.shouldReconnect=!1;this.messageQueue=[];this.pendingCommands=new Map;this.commandId=0;this.heartbeatTimer=null;this.heartbeatTimeoutTimer=null;this.lastPongTime=null;this.heartbeatSentTime=0;this.metrics={connectTime:null,reconnectCount:0,messagessent:0,messagesReceived:0,lastError:null};this.url=e,this.options={...f,...t},this._onOpen=this._onOpen.bind(this),this._onClose=this._onClose.bind(this),this._onError=this._onError.bind(this),this._onMessage=this._onMessage.bind(this)}async connect(){return new Promise((e,t)=>{if(this.state===o.CONNECTING||this.state===o.CONNECTED){e();return}this._log("debug","Initiating connection..."),this._setState(o.CONNECTING),this.shouldReconnect=!0,this._cleanup();let n=this.url;if(this.options.token){let i=this.url.includes("?")?"&":"?";n=`${this.url}${i}token=${encodeURIComponent(this.options.token)}`}try{this.ws=new WebSocket(n),this.ws.onopen=this._onOpen,this.ws.onclose=this._onClose,this.ws.onerror=this._onError,this.ws.onmessage=this._onMessage;let i=setTimeout(()=>{this.state===o.CONNECTING&&(this._log("error","Connection timeout"),this.disconnect(),t(new Error("Connection timeout")))},1e4);this.once("connected",()=>{clearTimeout(i),e()}),this.once("error",h=>{clearTimeout(i),t(h)})}catch(i){this._log("error","Failed to create WebSocket connection:",i),this._setState(o.DISCONNECTED),t(i)}})}disconnect(){this._log("debug","Disconnecting..."),this.shouldReconnect=!1,this._setState(o.CLOSING),this._stopHeartbeat(),this._clearReconnectTimer(),this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.close(1e3,"Client disconnect"):(this._cleanup(),this._setState(o.DISCONNECTED))}reconnect(){this._log("debug","Manual reconnect requested"),this.reconnectAttempts=0,this.disconnect(),setTimeout(()=>this.connect(),100)}async send(e){return new Promise((t,n)=>{if(!this.isConnected()){this.options.queueMessages?(this._queueMessage(e),this._log("debug","Message queued (not connected)",e),t()):n(new Error("Not connected"));return}try{let i=JSON.stringify(e);this.ws.send(i),this.metrics.messagessent++,this._log("debug","Message sent:",e),t()}catch(i){this._log("error","Failed to send message:",i),n(i)}})}async sendCommand(e,t={},n=5e3){return new Promise((i,h)=>{let l=this._generateCommandId(),g={type:e,id:l,...t},d=setTimeout(()=>{this.pendingCommands.delete(l),h(new Error(`Command timeout: ${e}`))},n);this.pendingCommands.set(l,{resolve:i,reject:h,timeout:d,command:e}),this.send(g).catch(p=>{clearTimeout(d),this.pendingCommands.delete(l),h(p)})})}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}isAuthenticated(){return this.authenticated&&this.userInfo!==null}getConnectionState(){return this.state}getQueuedMessageCount(){return this.messageQueue.length}getMetrics(){return{...this.metrics,uptime:this.metrics.connectTime?Date.now()-this.metrics.connectTime:0,latency:this.lastPongTime?this.lastPongTime-this.heartbeatSentTime:null}}getUserInfo(){return this.userInfo}_setState(e){if(this.state!==e){let t=this.state;this.state=e,this._log("debug",`State changed: ${t} -> ${e}`),this.emit("stateChange",{oldState:t,newState:e})}}_onOpen(){this._log("info","WebSocket connected"),this._setState(o.CONNECTED),this.metrics.connectTime=Date.now(),this.metrics.reconnectCount=this.reconnectAttempts,this.reconnectAttempts=0,this.lastError=null,this._startHeartbeat(),this._processMessageQueue(),this.emit("connected",{url:this.url,reconnectCount:this.metrics.reconnectCount})}_onClose(e){this._log("info",`WebSocket closed: ${e.code} ${e.reason}`),this._cleanup(),this._setState(o.DISCONNECTED),this.authenticated=!1,this.userInfo=null,this.emit("disconnected",{code:e.code,reason:e.reason,wasAuthenticated:this.authenticated}),this.shouldReconnect&&this.options.autoReconnect&&this._scheduleReconnect()}_onError(e){this._log("error","WebSocket error:",e);let t=new Error("WebSocket error");this.lastError=t,this.metrics.lastError=t,this.emit("error",t)}_onMessage(e){this.metrics.messagesReceived++;try{let t=JSON.parse(e.data);this._log("debug","Message received:",t),this._handleMessage(t)}catch(t){this._log("error","Failed to parse message:",t),this.emit("error",new Error("Invalid message format"))}}_handleMessage(e){let{type:t,id:n}=e;if(n&&this.pendingCommands.has(n)){let i=this.pendingCommands.get(n);clearTimeout(i.timeout),this.pendingCommands.delete(n),t===r.ERROR?i.reject(new Error(e.message||"Command failed")):i.resolve(e);return}switch(t){case r.AUTH_SUCCESS:this._handleAuthSuccess(e);break;case r.AUTH_ERROR:this._handleAuthError(e);break;case r.AUTH_REQUIRED:this._handleAuthRequired(e);break;case r.PONG:this._handlePong();break;case r.ERROR:this.emit("error",new Error(e.message||"Server error"));break;default:this.emit("message",e),this.emit(t,e);break}}_handleAuthSuccess(e){this._log("info","Authentication successful:",e),this.authenticated=!0,this.userInfo={userId:e.user_id,username:e.username,role:e.role},this._setState(o.AUTHENTICATED),this.emit("auth_success",e)}_handleAuthError(e){this._log("error","Authentication failed:",e),this.authenticated=!1,this.userInfo=null,this.emit("auth_failed",new Error(e.message||"Authentication failed"))}_handleAuthRequired(e){this._log("debug","Authentication required:",e),this._setState(o.AUTHENTICATING),this.options.token?this.send({type:r.AUTH,token:this.options.token}):this.emit("auth_failed",new Error("No authentication token provided"))}_handlePong(){this.lastPongTime=Date.now(),this._log("debug","Pong received"),this.heartbeatTimeoutTimer&&(clearTimeout(this.heartbeatTimeoutTimer),this.heartbeatTimeoutTimer=null)}_startHeartbeat(){this.options.heartbeatInterval<=0||(this._stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.isConnected()&&(this.heartbeatSentTime=Date.now(),this.send({type:r.PING}),this.heartbeatTimeoutTimer=setTimeout(()=>{this._log("warn","Heartbeat timeout - connection may be dead"),this.emit("heartbeatTimeout",[]),this.options.autoReconnect&&this.reconnect()},this.options.heartbeatTimeout))},this.options.heartbeatInterval))}_stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatTimeoutTimer&&(clearTimeout(this.heartbeatTimeoutTimer),this.heartbeatTimeoutTimer=null)}_queueMessage(e){this.messageQueue.length>=this.options.maxQueueSize&&this.messageQueue.shift(),this.messageQueue.push(e)}_processMessageQueue(){if(this.messageQueue.length===0)return;this._log("debug",`Processing ${this.messageQueue.length} queued messages`);let e=this.messageQueue.slice();this.messageQueue=[],e.forEach(t=>{this.send(t).catch(n=>{this._log("error","Failed to send queued message:",n)})})}_scheduleReconnect(){if(this.reconnectAttempts>=this.options.maxReconnectAttempts){this._log("error","Max reconnection attempts reached"),this.emit("reconnectFailed",{attempts:this.reconnectAttempts,lastError:this.lastError});return}this.reconnectAttempts++;let e=Math.min(this.options.reconnectDelay*Math.pow(this.options.reconnectDecay,this.reconnectAttempts-1),this.options.maxReconnectDelay);this._log("info",`Scheduling reconnect attempt ${this.reconnectAttempts}/${this.options.maxReconnectAttempts} in ${e}ms`),this._setState(o.RECONNECTING),this.emit("reconnecting",{attempt:this.reconnectAttempts,maxAttempts:this.options.maxReconnectAttempts,delay:e}),this._clearReconnectTimer(),this.reconnectTimer=setTimeout(()=>{this.shouldReconnect&&this.connect().catch(t=>{this._log("error","Reconnection failed:",t),this._scheduleReconnect()})},e)}_clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}_cleanup(){this._stopHeartbeat(),this.ws&&(this.ws.onopen=null,this.ws.onclose=null,this.ws.onerror=null,this.ws.onmessage=null,this.ws=null),this.pendingCommands.forEach(e=>{clearTimeout(e.timeout),e.reject(new Error("Connection closed"))}),this.pendingCommands.clear()}_generateCommandId(){return`cmd_${++this.commandId}_${Date.now()}`}_log(e,...t){if(!this.options.debug)return;let n={debug:0,info:1,warn:2,error:3},i=n[this.options.logLevel]||1;(n[e]||1)>=i&&console[e](`[WebSocketClient:${e.toUpperCase()}]`,...t)}},S=c;c.CONNECTION_STATES=o;c.MESSAGE_TYPES=r;c.EventEmitter=u;typeof globalThis!="undefined"&&(globalThis.WebSocketClient=c);return v(N);})();
/**
 * GoRouter WebSocket Client Library
 * A comprehensive WebSocket client library with authentication, reconnection, and message queuing
 * 
 * @version 1.0.0
 * @author GoRouter Team
 * @license MIT
 */
